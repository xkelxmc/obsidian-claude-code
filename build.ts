#!/usr/bin/env bun

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY BUN
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = Bun.argv.includes("--production");

// @ts-ignore
const result = await Bun.build({
	entrypoints: ["./src/main.ts"],
	outdir: ".",
	target: "node",
	format: "cjs",
	minify: prod,
	sourcemap: prod ? "none" : "inline",
	external: [
		"obsidian",
		"electron",
		"@codemirror/autocomplete",
		"@codemirror/collab",
		"@codemirror/commands",
		"@codemirror/language",
		"@codemirror/lint",
		"@codemirror/search",
		"@codemirror/state",
		"@codemirror/view",
		"@lezer/common",
		"@lezer/highlight",
		"@lezer/lr",
	],
	naming: {
		entry: "main.js",
	},
});

if (!result.success) {
	console.error("Build failed");
	for (const message of result.logs) {
		console.error(message);
	}
	process.exit(1);
}

// Add banner to output
// @ts-ignore
const mainJs = await Bun.file("main.js").text();
// @ts-ignore
await Bun.write("main.js", banner + "\n" + mainJs);

console.log(prod ? "Production build complete!" : "Build complete!");

// Watch mode for dev
if (!prod && Bun.argv.includes("--watch")) {
	console.log("Watching for changes...");
	// Bun will handle watch mode via the CLI
}
